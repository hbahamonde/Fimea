\documentclass{article}

\begin{document}

<<echo=FALSE, warning=FALSE>>=
cat("\014")
rm(list=ls())
setwd("/Users/hectorbahamonde/research/Fimea/")

# Pacman
if (!require("pacman")) install.packages("pacman"); library(pacman) 

# loadings
load("/Users/hectorbahamonde/research/Fimea/dat.RData")


# recoding
p_load(dplyr)
dat <- dat %>%
  mutate(outcome = factor(outcome, 
                          levels = c(
                            "The medicine should not be introduced with social funding",  # Least supportive (1)
                            "A medicine should be introduced at public expense if a company lowers its price",  # Middle (2)
                            "The medicine should be made available at public expense, regardless of the price charged by the company"  # Most supportive (3)
                          ), ordered = TRUE))

# Remove rows
p_load(tidyverse)
dat <- dat %>% filter(!is.na(outcome))
dat <- dat %>% filter(Frame != "Frame A") %>% mutate(Frame = fct_drop(Frame))  # Drop unused levels

# Recode the Frame variable
dat$Frame <- factor(dat$Frame, 
                    levels = c("Frame B", "Frame C", "Frame D"),  # Questionnaires
                    labels = c("Control", "Rule of Rescue", "Utility Maximizing"))

# recoding
dat$M1_1 = as.factor(dat$M1_1)
dat$M1_10 = as.factor(dat$M1_10) # income
dat$M1_2_1 = as.numeric(dat$M1_2_1) # Age
dat$M1_5 = as.factor(dat$M1_5) # Occupation (includes retired)
dat$M2_2 = as.factor(dat$M2_2) # Illness that affect function to work
dat$M2_5 = as.factor(dat$M2_5) # Have illness that entitles Kela compensation
dat$M2_6_0 = as.factor(dat$M2_6_0) # Has a long-term illness 
dat$M2_11 = as.factor(dat$M2_11) # how much spends on medicine
dat$PAINOKERROIN = as.numeric(dat$PAINOKERROIN) # weight
dat$M1_3 = as.factor(dat$M1_3) # marital status 
dat$M1_9 = as.factor(dat$M1_9) # region
dat$M2_1 = as.factor(dat$M2_1) # how's your health today
dat$M2_13 = as.factor(dat$M2_13) # had financial problems to buy medicines last year

# recode income
dat$income_group <- forcats::fct_collapse(dat$M1_10,
                                          "Low" = c("Up to 1000 â‚¬", "1001-2000 â‚¬"),  # use exact output from levels(dat$M1_10)
                                          "Middle" = c("2001-3000 â‚¬", "3001-4000 â‚¬"),
                                          "High" = c("4001-5000 â‚¬", "5001-8000 â‚¬", "Over 8000"),
                                          "Other/Unknown" = c("I do not want to answer", "I don't know"))

# Set "Control" as the reference category
dat$Frame <- relevel(dat$Frame, ref = "Control")

# Recode spending on medicine
dat$M2_11.r <- NA  # initialize new variable

dat$M2_11.r[dat$M2_11 %in% c(
  "I do not take medicines prescribed by my doctor",
  "All 100 â‚¬"
)] <- "low"

dat$M2_11.r[dat$M2_11 %in% c(
  "100-299 â‚¬", "300-599 â‚¬"
)] <- "mid"

dat$M2_11.r[dat$M2_11 == "600 â‚¬ or more"] <- "high"

dat$M2_11.r[dat$M2_11 == "I don't know"] <- NA  # optional, already NA if not matched

dat$M2_11.r = as.factor(dat$M2_11.r)

# recode age
dat$age_groups <- cut(
  dat$M1_2_1,
  breaks = c(17, 34, 59, 79),  # make sure lower bound includes 18
  labels = c("young", "middle", "old"),
  right = TRUE,
  include.lowest = TRUE
  )

dat$age_groups <- factor(dat$age_groups, levels = c("young", "middle", "old"))

# recode problems last year var
dat$M2_13_binary <- ifelse(
  dat$M2_13 == "There have been no problems at all",
  "no_problems",
  "problems"
  )

dat$M2_13_binary <- factor(dat$M2_13_binary, levels = c("no_problems", "problems"))

# models

# Question
## â€œThe benefits and costs of one new cancer drug are described below. Read the description and then answer the question. The new treatment is for a specific type of incurable cancer. In Finland, there are 10â€“20 patients each year for whom a new drug can be used.â€


# â€œrule of rescueâ€
## intuitive obligation to rescue people from death at any cost.
## Frame 2a: â€œThere is no cure for this particular type of cancer. 
## The new medicine is a possible option for patients who have already 
## received multiple treatments and for whom the remaining options are limitedâ€

#  â€œutility maximizingâ€
## rational principle of using resources in the way that they produce the 
## most health.
## Frame 2b: â€œThe funds available to healthcare are finite. The adoption 
## of the new medicine means that the funds used to pay for it will mean 
## cuts elsewhere in healthcareâ€

# Fit the ordinal logistic regression model
p_load(MASS)
# Ordered Logistic or Probit Regression

# Required base and control variable definitions
base_formula <- "Frame + M1_1 + M1_2_1 + income_group"
controls <- c("M1_9", "M2_5", "M2_11", "M2_6_0", "M1_3", "M2_2", "M1_5")
controls.main.model <- c("M1_9", "M2_5", "M2_11")
outcome_var <- "outcome"


model <- polr(as.formula(paste(outcome_var, "~", base_formula, "+", paste(controls.main.model, collapse = " + "))), 
              data = dat, 
              method = c("logistic"), # probit / logistic // probit was giving me predictions OUTSIDE of the range of the C.I.
              Hess = TRUE,
              weights = PAINOKERROIN)

# working model
# model <- polr(outcome ~ Frame + M1_1 + M1_2_1 + M1_3 + M1_5, data = dat, Hess = TRUE, weights = PAINOKERROIN)
# summary(model)

# Generate predicted probabilities for a predictor
p_load(ggeffects)
predicted_probs <- ggpredict(model, terms = "Frame")

# plot
p_load(ggplot2)
dodge <- position_dodge(width = 0.3)

# Frame descriptions
note_rule <- "Rule of Rescue:\nThere is no cure for this particular type of cancer. The new medicine is a possible option\n for patients who have already received multiple treatments and for whom the\nremaining options are limited."
note_utility <- "Utility Maximizing:\nThe funds available to healthcare are finite. The adoption of the new medicine means\nthat the funds used to pay for it will mean cuts elsewhere in healthcare."

ggplot(predicted_probs, 
       aes(x = x, y = predicted, color = response.level, 
           group = response.level)) + 
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), 
                  position = dodge) + 
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    legend.key.height = unit(0.5, "cm")
  ) +
  guides(colour = guide_legend(title = "", ncol = 1)) + 
  labs(
    title = "The new treatment is for a specific type of incurable cancer.\nIn Finland, there are 10â€“20 patients each year for\nwhom a new drug can be used.",
    x = "Frame",
    y = "Predicted Probabilities",
    caption = paste0(note_rule, "\n\n", note_utility)
  )





compare_estimates_ci <- function(est1, ci1, est2, ci2, level = c(0.90, 0.95)) {
  # Convert confidence intervals to standard errors
  z_values <- qnorm(1 - (1 - level) / 2)
  se1 <- (ci1[2] - ci1[1]) / (2 * qnorm(0.975))  # assumes 95% CI input
  se2 <- (ci2[2] - ci2[1]) / (2 * qnorm(0.975))
  
  diff <- est2 - est1
  se_diff <- sqrt(se1^2 + se2^2)
  
  results <- sapply(z_values, function(z) {
    z_score <- diff / se_diff
    is_significant <- abs(z_score) > z
    p_value <- 2 * (1 - pnorm(abs(z_score)))
    c(z_score = round(z_score, 3), 
      p_value = round(p_value, 4), 
      significant = is_significant)
  })
  
  colnames(results) <- paste0(level * 100, "% CI")
  return(as.data.frame(t(results)))
}

compare_two_frames <- function(predicted_probs, frame1, frame2, response_label, level = c(0.90, 0.95)) {
  subset_data <- predicted_probs %>%
    filter(x %in% c(frame1, frame2), response.level == response_label)

  est1 <- subset_data$predicted[subset_data$x == frame1]
  ci1 <- c(subset_data$conf.low[subset_data$x == frame1],
           subset_data$conf.high[subset_data$x == frame1])
  est2 <- subset_data$predicted[subset_data$x == frame2]
  ci2 <- c(subset_data$conf.low[subset_data$x == frame2],
           subset_data$conf.high[subset_data$x == frame2])

  compare_estimates_ci(est1, ci1, est2, ci2, level)
}

# Example usage
compare_two_frames(
  predicted_probs,
  frame1 = "Control",
  frame2 = "Rule of Rescue",
  response_label = "The medicine should be made available at public expense, regardless of the price charged by the company"
)


# Models
p_load(MASS)

build_sequential_models <- function(base_formula, controls, data, outcome_var, weights_var = NULL, method = "logistic") {
  models <- list()
  
  # Optional: Base model with no controls
  models[["m.0"]] <- polr(
    formula = as.formula(paste(outcome_var, "~", base_formula)),
    data = data,
    method = method,
    Hess = TRUE,
    weights = if (!is.null(weights_var)) data[[weights_var]] else NULL
  )

  for (i in seq_along(controls)) {
    control_terms <- paste(controls[1:i], collapse = " + ")
    full_formula_text <- paste(outcome_var, "~", base_formula, "+", control_terms)
    full_formula <- as.formula(full_formula_text)
    
    model_name <- paste0("m.", i)
    message("Fitting ", model_name, ": ", full_formula_text)  # ðŸ‘ˆ check formula

    models[[model_name]] <- polr(
      formula = full_formula,
      data = data,
      method = method,
      Hess = TRUE,
      weights = if (!is.null(weights_var)) data[[weights_var]] else NULL
    )
  }

  # Final model (redundant here, but keeping it for structure)
  # If you keep it, don't make it the same as m.7
  models[["m.final"]] <- models[[paste0("m.", length(controls))]]

  return(models)
}

# Run the function
models <- build_sequential_models(
  base_formula = base_formula,
  controls = controls,
  data = dat,
  outcome_var = outcome_var,
  weights_var = "PAINOKERROIN",
  method = "logistic"
)



# Interaction (income_group)
# 1. Framing effects are inelastic to income groups, e.g., both rich and poor react similarly to the frames.

model.int.1 <- polr(outcome ~ Frame*income_group + 
                M1_1 + # Gender
                M1_2_1 + # Age
                # M2_6_0 + # Has a long-term illness 
                # M1_3 +  # marital status 
                M2_2, # Illness that affect function to work
                # M1_5 + # Occupation (includes retired)
                #M2_11 + # how much spends on medicine
                #income_group, # income
              data = dat, 
              method = c("logistic"), # probit / logistic // probit was giving me predictions OUTSIDE of the range of the C.I.
              Hess = TRUE,
              weights = PAINOKERROIN)

predicted_probs <- ggpredict(model.int.1, terms = c("Frame", "income_group"))

ggplot(predicted_probs, 
       aes(x = x, y = predicted, color = group)) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                position = position_dodge(width = 0.5), width = 0.3) + 
  geom_line(position = position_dodge(width = 0.5), aes(group = group)) +
  geom_point(position = position_dodge(width = 0.5)) +
  facet_wrap(~response.level) + 
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    legend.key.height = unit(0.5, "cm")
  ) +
  guides(colour = guide_legend(title = "income_group", ncol = 1)) + 
  labs(x = "Frame", y = "Predicted Probabilities")

# Interaction (M2_13)
# 1. Framing effects are inelastic to income groups, e.g., both rich and poor react similarly to the frames.

model.int.2 <- polr(outcome ~ Frame*M2_13 + 
                M1_1 + # Gender
                M1_2_1 + # Age
                # M2_6_0 + # Has a long-term illness 
                # M1_3 +  # marital status 
                #M2_2 + # Illness that affect function to work
              # M1_5 + # Occupation (includes retired)
              #M2_11 + # how much spends on medicine
                M2_1, # income
              data = dat, 
              method = c("logistic"), # probit / logistic // probit was giving me predictions OUTSIDE of the range of the C.I.
              Hess = TRUE,
              weights = PAINOKERROIN)

predicted_probs <- ggpredict(model.int.2, terms = c("Frame", "M2_13"))

ggplot(predicted_probs, 
       aes(x = x, y = predicted, color = group)) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                position = position_dodge(width = 0.5), width = 0.3) + 
  geom_line(position = position_dodge(width = 0.5), aes(group = group)) +
  geom_point(position = position_dodge(width = 0.5)) +
  facet_wrap(~response.level) + 
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    legend.key.height = unit(0.5, "cm")
  ) +
  guides(colour = guide_legend(title = "M2_13", ncol = 1)) + 
  labs(x = "Frame", y = "Predicted Probabilities")

@


<<results='asis'>>=
p_load(texreg)

# Combine base model and sequential models
all_models <- c(list(model), models)

# Generate the table
texreg(models, 
          #omit.coef = "_2_",
          scalebox = 0.3)
@

\newpage

\subsection{Frames}

Rule of Rescue Frame:

\begin{itemize}
	\item	Emphasizes the patients' dire situation: last-resort treatment, few options left.
	\item This is a loss frame: respondents may become risk-seeking and more willing to support the policy.
	\item Prospect Theory predicts increased support under this framing.
\end{itemize}

Utility Maximizing Frame:

\begin{itemize}
	\item	This is closer to a gain or neutral frame â€” focusing on rational management rather than saving someone from certain death.
	\item Invokes more risk-averse behavior.
\end{itemize}

These results are inelastic to the combined effects (interaction term) of the frame presented and the subject's income nor to whether it is difficult to get medicines. 
	

\subsection{Roadmap}

\begin{enumerate}
 \item Political Psychology - Framing Effects - Public Policy - Prospect Theory
 \item Framing a public policy is relevant to gather support in favor of a certain political stance or public policy. They have huge practical consequences.
 \item Does the public prefer to maximize utilities or minimize losses? This question is fundamental to practitioners and government agencies in presenting and gathering public support for certain policies. With huge practical consequences not only on the said policy but also on budgetary issues and legitimizacy. 
 \item Traditional approaches predict that "utility-maximizing" approaches should gather more support (efficiency). However, we find that the public rather prefers minimizing losses (than maximizing utilities).



\end{enumerate}


\subsection{Sections of the Paper}
\begin{enumerate}
 \item Intro-Motivation: (para) Politics is about who gets what, where and when. Rethorics has been a fundamental aspect of politics (Aristotle). Since resources are scarse and needs are limitless, {\bf (think carefully what the question is)} 'What's an effective way to frame a public policy in welfare state societies'? Other questions: â€œHow do individuals cognitively evaluate public policy trade-offs when exposed to competing rhetorical frames?â€, â€œDoes the public react more strongly to frames emphasizing losses or those emphasizing efficiency in the context of public policy?â€, â€œWhat shapes citizensâ€™ policy preferences when trade-offs are framed in terms of rescue vs. efficiency?â€  How do ordinary citizens reason about trade-offs in health policy when exposed to competing frames grounded in loss avoidance versus utility maximization? This question speaks to foundational theories in political psychology and behavioral decision-making.
 \item Literature on framing and public policy (Mikko/Katri section).
 \item Our contribution is to introduce prospect theory from a  political psychology perspective to the literature on framing effects and public policy. 
 \item Methods; experimental design.
\end{enumerate}

\end{document}
